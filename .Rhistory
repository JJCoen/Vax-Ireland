# Lay out plots
uni <- grid.arrange(grobs=g_all, ncol = 3, nrow = 3,
left = yleft, bottom = bottom)
#save
g <- arrangeGrob(g0,g5, g15, g25, g35, g45, g55, g65, g75, nrow=3) #generates g
ggsave(file="./figures/linear_fit.jpeg", g) #saves g
irl_lin <- irl_20_22[ age_cat != "Total",]
irl_lin[age_cat %in% c("45-54", "55-64", "65-74", "75+"),
xs_lin := rate - lm]
ggplot(data=irl_lin, aes(x=age_cat, y=xs_lin,
fill= year)) +
geom_bar(stat="identity", position=position_dodge())+
scale_fill_brewer(palette="Paired") +
labs(
title ="Disparity in 75+ group",
subtitle = waiver(),
caption = "CSO census, popln estimates, and \nVSAQ2 mortality by age",
x = "age category",
y = "death rate difference from linear fit") +
annotate(geom = "text", x = "5-14", y = 100,
label = "Method 2C") +
theme_minimal() +
theme(legend.position='top',
legend.justification='left',
legend.direction='horizontal')
# ggsave("./figures/method2c-diff-lin-fit.jpeg")
irl_lin_older <- irl_lin[age_cat %in% c("45-54", "55-64", "65-74", "75+"),
xs_lin := rate - lm]
ggplot(data=irl_lin_older, aes(x=age_cat, y=xs_lin,
fill= year)) +
geom_bar(stat="identity", position=position_dodge())+
scale_fill_brewer(palette="Paired") +
labs(
title ="Disparity in 75+ group",
subtitle = waiver(),
caption = "CSO census, popln estimates, and \nVSAQ2 mortality by age",
x = "age category",
y = "death rate difference from linear fit") +
annotate(geom = "text", x = "5-14", y = 100,
label = "Method 2C") +
theme_minimal() +
theme(legend.position='top',
legend.justification='left',
legend.direction='horizontal')
# ggsave("./figures/method2c-diff-lin-fit.jpeg")
irl_lin <- irl_20_22[ !(age_cat %in% c("0-4", "5-14", "15-24", "25-34", "35-44","Total") ), ]
irl_lin[,  xs_lin := rate - lm]
ggplot(data=irl_lin, aes(x=age_cat, y=xs_lin,
fill= year)) +
geom_bar(stat="identity", position=position_dodge())+
scale_fill_brewer(palette="Paired") +
labs(
title ="Disparity in 75+ group",
subtitle = waiver(),
caption = "CSO census, popln estimates, and \nVSAQ2 mortality by age",
x = "age category",
y = "death rate difference from linear fit") +
annotate(geom = "text", x = "5-14", y = 100,
label = "Method 2C") +
theme_minimal() +
theme(legend.position='top',
legend.justification='left',
legend.direction='horizontal')
# ggsave("./figures/method2c-diff-lin-fit.jpeg")
irl_lin[,  xs_lin := (rate/lm-1)*100]
ggplot(data=irl_lin, aes(x=age_cat, y=xs_lin,
fill= year)) +
geom_bar(stat="identity", position=position_dodge())+
scale_fill_brewer(palette="Paired") +
scale_y_continuous(labels = scales::percent_format(scale = 1)) +
labs(
title ="Disparity in 75+ group",
subtitle = waiver(),
caption = "CSO census, popln estimates, and \nVSAQ2 mortality by age",
x = "age category",
y = "death rate difference from linear fit") +
annotate(geom = "text", x = "5-14", y = 100,
label = "Method 2C") +
theme_minimal() +
theme(legend.position='top',
legend.justification='left',
legend.direction='horizontal')
# ggsave("./figures/method2c-diff-lin-fit.jpeg")
ggplot(data=irl_lin, aes(x=age_cat, y=xs_lin,
fill= year)) +
geom_bar(stat="identity", position=position_dodge())+
scale_fill_brewer(palette="Paired") +
scale_y_continuous(labels = scales::percent_format(scale = 1)) +
labs(
title ="Disparity in 75+ group",
subtitle = waiver(),
caption = "CSO census, popln estimates, and \nVSAQ2 mortality by age",
x = "age category",
y = "death rate difference from linear fit") +
annotate(geom = "text", x = "75+", y = 15,
label = "Method 2C") +
theme_minimal() +
theme(legend.position='top',
legend.justification='left',
legend.direction='horizontal')
# ggsave("./figures/method2c-diff-lin-fit.jpeg")
ggsave("./figures/method2c-diff-lin-fit.jpeg")
renv::status()
install.packages("assertr")
install.packages("docstring")
install.packages("Hmisc")
install.packages("plyr")
#| include: false
#| label: load_libraries
library(data.table)
library(kableExtra)
library(gt)
library(tidyverse)
library(ggpubr)
library(grid)     # textGrob
library(gridExtra)
library(janitor)
library(tidyr)
library(writexl)
library(cowplot)
library(purrr)
#| include: false
#| label: "mortality rate"
irl_mort <- readRDS(file = "./processed-data/irl_mort.rds") |>
setDT()
irl_mort[, mort_count := count][, count := NULL]
irl_pop <- readRDS(file = "./processed-data/irl_pop.rds") |>
setDT()
# filter out "Total" age category
age_vec <- c("0-4", "5-14", "15-24", "25-34", "35-44", "45-54", "55-64", "65-74", "75+")
irl_pop <- irl_pop[age_cat %in% age_vec,]
irl_mort <- irl_mort[age_cat %in% age_vec, ]
irl_dt <- irl_mort[, pop_count := irl_pop$pop_count]
irl_dt[, rate := mort_count/pop_count * 100000][, rate := floor(rate)]
setcolorder(irl_dt, c("year", "age_cat", "mort_count", "pop_count", "rate"))
irl_dt |>
head() |>
gt()
#| include: false
#| label: "mortality rate"
irl_mort <- readRDS(file = "./processed-data/irl_mort.rds") |>
setDT()
irl_mort[, mort_count := count][, count := NULL]
irl_pop <- readRDS(file = "./processed-data/irl_pop.rds") |>
setDT()
# filter out "Total" age category
age_vec <- c("0-4", "5-14", "15-24", "25-34", "35-44", "45-54", "55-64", "65-74", "75+")
irl_pop <- irl_pop[age_cat %in% age_vec,]
irl_mort <- irl_mort[age_cat %in% age_vec, ]
irl_dt <- irl_mort[, pop_count := irl_pop$pop_count]
irl_dt[, rate := mort_count/pop_count * 100000][, rate := floor(rate)]
setcolorder(irl_dt, c("year", "age_cat", "mort_count", "pop_count", "rate"))
irl_dt |>
head() |>
gt()
#| label: "excess above average"
#|
avg_vec <- irl_mort[year %in% 2015:2019,
floor(mean(mort_count)),
by = age_cat ][, V1]
# extract years 2020 to 2022
irl_mort_xs <- irl_mort[year %in% 2020:2022, .(year, age_cat, mort_count)]
irl_mort_xs[, mort_xs := (mort_count/avg_vec - 1)*100, by = year] |>
head() |>
gt()
#| message: false
# Set the base rate from year 2019 values
base <- irl_dt[year==2019, rate]
# Create a baseline vector for the three years 2020 - 2022
base <- rep(base, 3)
# Calculate percent change relative to death rate for 2019
irl_dt[year %in% 2020:2022,
xs_base := round((rate/base-1)*100, 5)]
irl_dt[year %in% 2020:2023,] |>
head() |>
gt()
#| message: false
#| # Set the base rate from year 2019 values
# Calculate difference between yearly death rate and
# death rate for 2019
irl_dt[year %in% 2020:2022, xs_diff := round(rate - base, 5)]
irl_dt[year %in% 2020:2022,] |>
head() |>
gt()
#| message: false
irl_20_22 <- irl_dt[year %in% 2020:2022,]
irl_20_22[, year := as.factor(year)]
ggplot(data=irl_20_22, aes(x=age_cat, y=xs_base,
fill= year)) +
geom_bar(stat="identity", position=position_dodge())+
scale_fill_brewer(palette="Paired") +
scale_y_continuous(labels = scales::percent_format(scale = 1)) +
labs(
title ="75+ in 2022: only group with excess mortality",
subtitle = waiver(),
caption = "CSO census, popln estimates, and \nVSAQ2 mortality by age",
x = "age category",
y = "death rate above baseline") +
annotate(geom = "text", x = "5-14", y = 10,
label = "Method 2A") +
theme_minimal() +
theme(legend.position='top',
legend.justification='left',
legend.direction='horizontal')
ggsave("./figures/method2a-xs_base.jpeg")
#| message: false
irl_20_22 <- irl_dt[year %in% 2020:2022,]
irl_20_22[, year := as.factor(year)]
ggplot(data=irl_20_22, aes(x=age_cat, y=xs_base,
fill= year)) +
geom_bar(stat="identity", position=position_dodge())+
scale_fill_brewer(palette="Paired") +
scale_y_continuous(labels = scales::percent_format(scale = 1)) +
labs(
title ="Younger groups have reduced mortality",
subtitle = waiver(),
caption = "CSO census, popln estimates, and \nVSAQ2 mortality by age",
x = "age category",
y = "death rate above baseline") +
annotate(geom = "text", x = "5-14", y = 10,
label = "Method 2A") +
theme_minimal() +
theme(legend.position='top',
legend.justification='left',
legend.direction='horizontal')
ggsave("./figures/method2a-xs_base.jpeg")
newx <- 2020:2022
mod0 <- lm(rate ~ year, irl_lin_fit[age_cat == "0-4", ])
irl_lin_fit <- irl_dt[ year %in% c(2010:2019), ]
newx <- 2020:2022
mod0 <- lm(rate ~ year, irl_lin_fit[age_cat == "0-4", ])
predict0 <- predict(mod0, newdata = data.frame(year = newx))
irl_20_22[age_cat=="0-4", lm := predict0]
mod5 <- lm(rate ~ year, irl_lin_fit[age_cat == "5-14", ])
predict5 <- predict(mod5, newdata = data.frame(year = newx))
irl_20_22[age_cat=="5-14", lm := predict5]
mod15 <- lm(rate ~ year, irl_lin_fit[age_cat == "15-24", ])
predict15 <- predict(mod15, newdata = data.frame(year = newx))
irl_20_22[age_cat=="15-24", lm := predict15]
mod25 <- lm(rate ~ year, irl_lin_fit[age_cat == "25-34", ])
predict25 <- predict(mod25, newdata = data.frame(year = newx))
irl_20_22[age_cat=="25-34", lm := predict25]
mod35 <- lm(rate ~ year, irl_lin_fit[age_cat == "35-44", ])
predict35 <- predict(mod35, newdata = data.frame(year = newx))
irl_20_22[age_cat=="35-44", lm := predict35]
mod45 <- lm(rate ~ year, irl_lin_fit[age_cat == "45-54", ])
predict45 <- predict(mod45, newdata = data.frame(year = newx))
irl_20_22[age_cat=="45-54", lm := predict45]
mod55 <- lm(rate ~ year, irl_lin_fit[age_cat == "55-64", ])
predict55 <- predict(mod55, newdata = data.frame(year = newx))
irl_20_22[age_cat=="55-64", lm := predict55]
mod65 <- lm(rate ~ year, irl_lin_fit[age_cat == "65-74", ])
predict65 <- predict(mod65, newdata = data.frame(year = newx))
irl_20_22[age_cat=="65-74", lm := predict65]
mod75 <- lm(rate ~ year, irl_lin_fit[age_cat == "75+", ])
predict75 <- predict(mod75, newdata = data.frame(year = newx))
irl_20_22[age_cat=="75+", lm := predict75]
irl_lin <- irl_20_22[ !(age_cat %in% c("0-4", "5-14", "15-24", "25-34", "35-44","Total") ), ]
irl_lin[,  xs_lin := (rate/lm-1)*100]
ggplot(data=irl_lin, aes(x=age_cat, y=xs_lin,
fill= year)) +
geom_bar(stat="identity", position=position_dodge())+
scale_fill_brewer(palette="Paired") +
scale_y_continuous(labels = scales::percent_format(scale = 1)) +
labs(
title ="Disparity in 75+ group",
subtitle = waiver(),
caption = "CSO census, popln estimates, and \nVSAQ2 mortality by age",
x = "age category",
y = "death rate difference from linear fit") +
annotate(geom = "text", x = "75+", y = 15,
label = "Method 2C") +
theme_minimal() +
theme(legend.position='top',
legend.justification='left',
legend.direction='horizontal')
# ggsave("./figures/method2c-diff-lin-fit.jpeg")
ggplot(data=irl_lin, aes(x=age_cat, y=xs_lin,
fill= year)) +
geom_bar(stat="identity", position=position_dodge())+
scale_fill_brewer(palette="Paired") +
scale_y_continuous(labels = scales::percent_format(scale = 1)) +
labs(
title ="Middle ages have increased mortality rates",
subtitle = waiver(),
caption = "CSO census, popln estimates, and \nVSAQ2 mortality by age",
x = "age category",
y = "death rate difference from linear fit") +
annotate(geom = "text", x = "75+", y = 15,
label = "Method 2C") +
theme_minimal() +
theme(legend.position='top',
legend.justification='left',
legend.direction='horizontal')
ggsave("./figures/method2c-diff-lin-fit.jpeg")
irl_lin <- irl_20_22[ !(age_cat %in% c("0-4", "5-14", "25-34", "35-44", "75+", "Total") ), ]
irl_lin[,  xs_lin := (rate/lm-1)*100]
ggplot(data=irl_lin, aes(x=age_cat, y=xs_lin,
fill= year)) +
geom_bar(stat="identity", position=position_dodge())+
scale_fill_brewer(palette="Paired") +
scale_y_continuous(labels = scales::percent_format(scale = 1)) +
labs(
title ="Middle ages have increased mortality rates",
subtitle = waiver(),
caption = "CSO census, popln estimates, and \nVSAQ2 mortality by age",
x = "age category",
y = "death rate difference from linear fit") +
annotate(geom = "text", x = "75+", y = 15,
label = "Method 2C") +
theme_minimal() +
theme(legend.position='top',
legend.justification='left',
legend.direction='horizontal')
ggsave("./figures/method2c-diff-lin-fit.jpeg")
ggplot(data=irl_lin, aes(x=age_cat, y=xs_lin,
fill= year)) +
geom_bar(stat="identity", position=position_dodge())+
scale_fill_brewer(palette="Paired") +
scale_y_continuous(labels = scales::percent_format(scale = 1)) +
labs(
title ="Middle ages have increased mortality rates",
subtitle = waiver(),
caption = "CSO census, popln estimates, and \nVSAQ2 mortality by age",
x = "age category",
y = "death rate difference from linear fit") +
annotate(geom = "text", x = "65-74", y = 20,
label = "Method 2C") +
theme_minimal() +
theme(legend.position='top',
legend.justification='left',
legend.direction='horizontal')
ggsave("./figures/method2c-diff-lin-fit.jpeg")
ggplot(data=irl_lin, aes(x=age_cat, y=xs_lin,
fill= year)) +
geom_bar(stat="identity", position=position_dodge())+
scale_fill_brewer(palette="Paired") +
scale_y_continuous(labels = scales::percent_format(scale = 1)) +
labs(
title ="Young Adults ~80% above trend",
subtitle = waiver(),
caption = "CSO census, popln estimates, and \nVSAQ2 mortality by age",
x = "age category",
y = "death rate difference from linear fit") +
annotate(geom = "text", x = "65-74", y = 20,
label = "Method 2C") +
theme_minimal() +
theme(legend.position='top',
legend.justification='left',
legend.direction='horizontal')
ggsave("./figures/method2c-diff-lin-fit.jpeg")
mort_table <- pivot_wider(mort_yr,
names_from = age_cat,
values_from = count) |>
as.data.table()
#| eval: false
library(htmltools)
htmltools::includeHTML("./scripts/CD205-Pop-2011.html")
#| label: load libraries
#| include: false
library(data.table)
library(readxl)
library(janitor)
library(tidyr)
library(gt)
#| include: false
#| label: load_libraries
library(data.table)
library(kableExtra)
library(gt)
library(tidyverse)
library(ggpubr)
library(grid)     # textGrob
library(gridExtra)
library(janitor)
library(tidyr)
library(writexl)
library(cowplot)
library(purrr)
#| include: false
#| label: "mortality rate"
irl_mort <- readRDS(file = "./processed-data/irl_mort.rds") |>
setDT()
irl_mort[, mort_count := count][, count := NULL]
irl_pop <- readRDS(file = "./processed-data/irl_pop.rds") |>
setDT()
# filter out "Total" age category
age_vec <- c("0-4", "5-14", "15-24", "25-34", "35-44", "45-54", "55-64", "65-74", "75+")
irl_pop <- irl_pop[age_cat %in% age_vec,]
irl_mort <- irl_mort[age_cat %in% age_vec, ]
irl_dt <- irl_mort[, pop_count := irl_pop$pop_count]
irl_dt[, rate := mort_count/pop_count * 100000][, rate := floor(rate)]
setcolorder(irl_dt, c("year", "age_cat", "mort_count", "pop_count", "rate"))
irl_dt |>
head() |>
gt()
#| label: "excess above average"
#|
avg_vec <- irl_mort[year %in% 2015:2019,
floor(mean(mort_count)),
by = age_cat ][, V1]
# extract years 2020 to 2022
irl_mort_xs <- irl_mort[year %in% 2020:2022, .(year, age_cat, mort_count)]
irl_mort_xs[, mort_xs := (mort_count/avg_vec - 1)*100, by = year] |>
head() |>
gt()
#| message: false
#| label: "plot excess above average"
#|
irl_mort_xs[, year := as.factor(year)]
ggplot(data=irl_mort_xs, aes(x=age_cat, y=mort_xs,
fill= year)) +
geom_bar(stat="identity", position=position_dodge())+
scale_fill_brewer(palette="Paired") +
scale_y_continuous(labels = scales::percent_format(scale = 1)) +
labs(
title ="younger are lower than average",
subtitle = waiver(),
caption = "CSO census, popln estimates, and \nVSAQ2 mortality by age",
x = "age category",
y = "death rate above average") +
annotate(geom = "text", x = "0-4", y = 15,
label = "Method 1") +
theme_minimal() +
theme(legend.position='top',
legend.justification='left',
legend.direction='horizontal')
# ggsave("./figures/method1-diff-avg.jpeg")
#| label: "output xs above age to excel"
# excess_table <- pivot_wider(irl_mort_xs[, .(year, age_cat, mort_xs)],
#             names_from = year,
#             values_from = mort_xs)
#
# write_xlsx(excess_table, path = "./processed-data/Table_10_excess_avg.xlsx")
#| message: false
# Set the base rate from year 2019 values
base <- irl_dt[year==2019, rate]
# Create a baseline vector for the three years 2020 - 2022
base <- rep(base, 3)
# Calculate percent change relative to death rate for 2019
irl_dt[year %in% 2020:2022,
xs_base := round((rate/base-1)*100, 5)]
irl_dt[year %in% 2020:2023,] |>
head() |>
gt()
# excess_base <- irl_dt[year %in% 2020:2022, .(year, age_cat, xs_base)]
#
# excess_table <- pivot_wider(excess_base, names_from = year,
#             values_from = xs_base)
#
# write_xlsx(excess_table, path = "./processed-data/Table_11_excess_base.xlsx")
#| message: false
irl_20_22 <- irl_dt[year %in% 2020:2022,]
irl_20_22[, year := as.factor(year)]
ggplot(data=irl_20_22, aes(x=age_cat, y=xs_base,
fill= year)) +
geom_bar(stat="identity", position=position_dodge())+
scale_fill_brewer(palette="Paired") +
scale_y_continuous(labels = scales::percent_format(scale = 1)) +
labs(
title ="Younger groups have reduced mortality",
subtitle = waiver(),
caption = "CSO census, popln estimates, and \nVSAQ2 mortality by age",
x = "age category",
y = "death rate above baseline") +
annotate(geom = "text", x = "5-14", y = 10,
label = "Method 2A") +
theme_minimal() +
theme(legend.position='top',
legend.justification='left',
legend.direction='horizontal')
# ggsave("./figures/method2a-xs_base.jpeg")
EStat_mort <- readRDS("./processed-data/EStat_mort.rds") |>
setDT()
EStat_mort[, mort_count := count][, count := NULL]
EStat_dt <- irl_pop[1:120, mort_count := EStat_mort$mort_count]
EStat_dt[, age_cat := as.factor(age_cat)][, Year := as.factor(Year)]
EStat_dt[, rate := mort_count/pop_count * 100000][, rate := floor(rate)]
EStat_dt |>
#    head() |>
gt()
#| message: false
#|
# Set the base rate from year 2019 values
base <- EStat_dt[Year==2019, rate]
# Create a baseline vector for the two years 2020 - 2021
base <- rep(base, 2)
# Calculate difference between yearly death rate and
# death rate for 2019
EStat_dt[Year %in% 2020:2021, xs_base := round((rate-base)*100, 5)]
EStat_dt[Year %in% 2020:2021,] |>
head() |>
gt()
#| message: false
ggplot(EStat_dt[Year %in% 2020:2021,],
aes(x=age_cat, y=xs_diff,
fill= Year)) +
geom_bar(stat="identity", position=position_dodge())+
scale_fill_brewer(palette="Paired") +
labs(
title ="0-4 years: only group with excess mortality",
subtitle = waiver(),
caption = "ESTAT mortality by age dataset DEMO_MAGEC",
x = "age category",
y = "death rate above average") +
theme_minimal() +
annotate(geom = "text", x = "75+", y = 1300,
label = "Method 2A") +
theme(legend.position='top',
legend.justification='left',
legend.direction='horizontal')
getwd()
